<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de Fotos para Planilha</title>
    <!-- Carrega Tailwind CSS para estilização fluida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para a fonte Inter e fundo */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Estilo para o botão de arquivo personalizado */
        .custom-file-input::-webkit-file-upload-button { visibility: hidden; }
        .custom-file-input::before {
            content: 'Selecionar Fotos';
            display: inline-block;
            background: #4f46e5;
            color: white;
            border: 1px solid #4f46e5;
            border-radius: 0.5rem;
            padding: 8px 12px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
        }
        .custom-file-input:hover::before { background: #4338ca; }
        .custom-file-input:active::before { background: #3730a3; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-xl bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-6 border-b pb-2">Vínculo de Fotos do Produto</h1>
        <p class="text-sm text-gray-600 mb-8">Insira os dados e as fotos. O sistema irá localizar o registro na planilha pela **OR** e **COD+VARIAÇÃO**.</p>

        <form id="uploadForm" class="space-y-6">

            <!-- Campo OR (Ordem de Recebimento/Serviço) -->
            <div>
                <label for="or" class="block text-sm font-medium text-gray-700">Número da OR (Obrigatório)</label>
                <input type="text" id="or" required placeholder="Ex: 547041"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            </div>

            <!-- Campo COD+VARIAÇÃO -->
            <div>
                <label for="codVariacao" class="block text-sm font-medium text-gray-700">COD + VARIAÇÃO (Obrigatório)</label>
                <input type="text" id="codVariacao" required placeholder="Ex: 120036+036"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <p class="mt-1 text-xs text-gray-500">Deve ser o valor exato da coluna 'PRODUTO' da planilha.</p>
            </div>

            <!-- Campo de Upload de Arquivo -->
            <div>
                <label for="fotos" class="block text-sm font-medium text-gray-700 mb-2">Fotos do Produto (Obrigatório)</label>
                <input type="file" id="fotos" required multiple accept="image/*"
                       class="custom-file-input w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <p id="fileCount" class="mt-2 text-sm text-gray-500"></p>
            </div>
            
            <!-- Indicador de Progresso e Mensagens -->
            <div id="messageBox" class="p-3 rounded-lg text-sm hidden" role="alert"></div>

            <!-- Botão de Envio -->
            <button type="submit" id="submitButton"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 disabled:bg-indigo-400">
                <span id="buttonText">Vincular Fotos e Atualizar Planilha</span>
                <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>
    </div>

    <script>
        // *** ⚠️ ESTE É O ÚNICO CAMPO QUE VOCÊ DEVE ALTERAR APÓS IMPLANTAR O APPS SCRIPT! ⚠️ ***
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyDSSXMUhYC1R35c3PZGBYPcf9NMv7iUMPSV5ioBMWSsG8he25l9VQt4Hu2KnJQAQj-/exec"; 
        // Exemplo: "https://script.google.com/macros/s/AKfyc.../exec"
        // ***********************************************************************************

        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fotos');
        const fileCountSpan = document.getElementById('fileCount');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const messageBox = document.getElementById('messageBox');
        
        // Atualiza a contagem de arquivos
        fileInput.addEventListener('change', () => {
            const count = fileInput.files.length;
            fileCountSpan.textContent = count > 0 ? `Total de arquivos selecionados: ${count}` : '';
        });

        // Função para exibir mensagem de status
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = 'p-3 rounded-lg text-sm';
            if (isError) {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            }
            messageBox.classList.remove('hidden');
        }

        // Converte o arquivo em Base64 para envio via JSON/POST
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    data: reader.result.split(',')[1], // Apenas a parte Base64
                    name: file.name,
                    mimeType: file.type
                });
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (GAS_WEB_APP_URL === "SUA_URL_DO_APPS_SCRIPT_AQUI") {
                showMessage("ERRO: Por favor, configure a variável GAS_WEB_APP_URL com o link do seu Apps Script.", true);
                return;
            }

            const or = document.getElementById('or').value.trim();
            const codVariacao = document.getElementById('codVariacao').value.trim();
            const files = fileInput.files;

            if (!or || !codVariacao || files.length === 0) {
                showMessage("Por favor, preencha todos os campos e selecione pelo menos uma foto.", true);
                return;
            }

            // Ativa o estado de carregamento
            submitButton.disabled = true;
            buttonText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            messageBox.classList.add('hidden');

            try {
                // 1. Converte todos os arquivos para Base64
                const filePromises = Array.from(files).map(fileToDataUrl);
                const fileDataArray = await Promise.all(filePromises);

                // 2. Prepara o payload para o Apps Script
                const payload = {
                    action: 'uploadAndLink',
                    or: or,
                    cod_variacao: codVariacao,
                    files: fileDataArray 
                };

                // 3. Envia para o Google Apps Script
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    // Apps Script espera dados de formulário, não JSON puro no POST, por isso usamos URLSearchParams
                    body: new URLSearchParams({ payload: JSON.stringify(payload) })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`Sucesso! ${result.message}`, false);
                    // Limpa o formulário após o sucesso
                    form.reset();
                    fileCountSpan.textContent = '';
                } else {
                    showMessage(`Falha: ${result.message}`, true);
                }

            } catch (error) {
                console.error('Erro ao enviar dados:', error);
                showMessage('Ocorreu um erro de conexão. Verifique o console ou a URL do Apps Script.', true);
            } finally {
                // Desativa o estado de carregamento
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>

